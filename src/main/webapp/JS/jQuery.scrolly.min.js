(function($) {

    function calculateScrollPosition(selector, options) {
        var element, anchorPos, scrollPos;

        if ((element = $(selector)).length === 0) return null;
        anchorPos = element.offset().top;

        switch (options.anchor) {
            case "middle":
                scrollPos = anchorPos - ( $(window).height() - element.outerHeight() ) / 2;
                break;
            default:
            case "top":
                scrollPos = Math.max(anchorPos, 0);
                break;
        }

        if (typeof options.offset === "function") {
            scrollPos -= options.offset();
        } else {
            scrollPos -= options.offset;
        }
        return scrollPos;
    }

    $.fn.scrolly = function(options) {
        var settings, anchor, scrollPos, $this = $(this);

        if (this.length === 0) 
            return $this;
        if (this.length > 1) {
            for (var i = 0; i < this.length; i++) {
                $(this[i]).scrolly(options);
            }
            return $this;
        }

        settings = $.extend({
            anchor: "top",       
            easing: "swing",     
            offset: 0,           
            parent: $("body,html"), 
            pollOnce: false,    
            speed: 1000         
        }, options);

        anchor = $this.attr("href");

        if (anchor.charAt(0) !== "#" || anchor.length < 2) return $this;

        if (settings.pollOnce) {
            scrollPos = calculateScrollPosition(anchor, settings);
        }

        $this.off("click.scrolly").on("click.scrolly", function(event) {
            scrollPos = scrollPos !== null ? scrollPos : calculateScrollPosition(anchor, settings);
            if (scrollPos !== null) {
                event.preventDefault();
                settings.parent.stop().animate({
                    scrollTop: scrollPos
                }, settings.speed, settings.easing);
            }
        });

        return $this;
    };

})(jQuery);